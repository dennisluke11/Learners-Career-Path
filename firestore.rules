rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow read access to all collections for authenticated and unauthenticated users
    // In production, you may want to restrict this further
    
    // Countries collection - public read
    match /countries/{document=**} {
      allow read: if true;
      allow write: if false; // Only admins can write (configure separately)
    }
    
    // Careers collection - public read
    match /careers/{document=**} {
      allow read: if true;
      allow write: if false; // Only admins can write (configure separately)
    }
    
    // Country subjects - public read
    match /countrySubjects/{document=**} {
      allow read: if true;
      allow write: if false; // Only admins can write (configure separately)
    }
    
    // Country grade levels - public read
    match /countryGradeLevels/{document=**} {
      allow read: if true;
      allow write: if false; // Only admins can write (configure separately)
    }
    
    // Announcements collection - public read, admin write
    match /announcements/{document=**} {
      allow read: if true;
      allow write: if false; // Only admins can write (configure separately)
      // Allow increment operations for views/clicks tracking
      // When using increment(), Firestore sends the field update directly
      // Allow update if only views and/or clicks are being modified
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['views', 'clicks']);
    }
    
    // User events - public write for analytics
    // TODO: In production, restrict read access using Firebase Auth with custom claims
    // For now, allowing read access for admin dashboard functionality
    match /userEvents/{document=**} {
      allow read: if true; // TODO: Restrict to authenticated admins in production
      allow create: if true; // Anyone can create events
      allow update, delete: if false;
    }
    
    // Market data collection - public read
    match /marketData/{document=**} {
      allow read: if true;
      allow write: if false; // Only admins can write (configure separately)
    }
    
    // Study resources collection - public read
    match /studyResources/{document=**} {
      allow read: if true;
      allow write: if false; // Only admins can write (configure separately)
    }
    
    // FCM tokens collection - allow users to write their own tokens
    match /fcmTokens/{tokenId} {
      // Allow write if data contains required fields
      allow write: if request.resource.data.keys().hasAll(['token', 'country', 'updatedAt']) &&
                     request.resource.data.token is string &&
                     request.resource.data.country is string &&
                     request.resource.data.updatedAt is string;
      // Only server (Firebase Functions) can read tokens
      allow read: if false;
    }
    
    // Admin users collection - allow read for authentication
    // TODO: In production, restrict this to authenticated requests only
    // For now, allowing read access for admin login functionality
    match /adminUsers/{userId} {
      allow read: if true; // Allow reading admin users for authentication
      allow write: if false; // Only server/admin SDK can write (configure separately)
    }
    
    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}


