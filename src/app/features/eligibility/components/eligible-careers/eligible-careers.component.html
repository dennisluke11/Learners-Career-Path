<section *ngIf="grades && Object.keys(grades).length > 0" class="eligible-careers-container" aria-labelledby="eligible-careers-heading">
  <h2 id="eligible-careers-heading">
    <span aria-hidden="true">üéì</span>
    <span class="sr-only">Courses and careers: </span>
    Courses & Careers You Qualify For
  </h2>
  <p class="subtitle">Based on your current grades, here are the opportunities available to you</p>

  <div *ngIf="loading" class="loading" role="status" aria-live="polite" aria-busy="true">
    <p>Checking your eligibility...</p>
  </div>

  <div *ngIf="!loading">
    <!-- Fully Qualified Careers -->
    <div *ngIf="qualifiedCareers.length > 0" class="careers-section qualified-section" aria-labelledby="qualified-heading">
      <h3 id="qualified-heading" class="section-title">
        <span class="icon" aria-hidden="true">‚úÖ</span>
        <span class="sr-only">Fully qualified section: </span>
        Fully Qualified ({{ qualifiedCareers.length }})
      </h3>
      <p class="section-description">Congratulations! You meet all requirements for these careers.</p>
      
      <div class="careers-grid">
        <div *ngFor="let eligible of qualifiedCareers" class="career-card qualified">
          <div class="career-header">
            <h4>{{ eligible.career.name }}</h4>
            <span class="status-badge qualified-badge">{{ getStatusLabel(eligible.status) }}</span>
          </div>
          <div class="career-info">
            <div class="match-score">
              <span class="score-label">Match Score:</span>
              <span class="score-value">{{ eligible.matchScore }}%</span>
            </div>
            <div class="requirements-met">
              <span class="success-message">‚úì All requirements met!</span>
            </div>
            
            <!-- Market Data Section -->
            <div class="market-data-section">
              <div *ngIf="isMarketDataLoading(eligible.career.name)" class="market-loading">
                <span>Loading market data...</span>
              </div>
              
              <div *ngIf="!isMarketDataLoading(eligible.career.name) && getMarketData(eligible.career.name)" class="market-info">
                <!-- Total Job Count (Last 12 Months) -->
                <div *ngIf="getMarketData(eligible.career.name)?.totalJobCount" class="job-count">
                  <span class="market-label">
                    <span aria-hidden="true">üìä</span>
                    <span class="sr-only">Market data: </span>
                    Total Jobs (Last 12 Months):
                  </span>
                  <span class="count-value">{{ formatNumber(getMarketData(eligible.career.name)!.totalJobCount!) }}</span>
                  <div *ngIf="getMarketData(eligible.career.name)?.jobCountsBySite && getMarketData(eligible.career.name)!.jobCountsBySite!.length > 0" class="job-counts-by-site">
                    <span class="sites-label">From:</span>
                    <span *ngFor="let siteCount of getMarketData(eligible.career.name)!.jobCountsBySite!" class="site-count">
                      {{ siteCount.site }} ({{ formatNumber(siteCount.count) }})
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- University Button -->
              <div class="university-button-section" *ngIf="hasUniversitySources(eligible.career)">
                <button 
                  class="view-universities-btn"
                  (click)="openUniversityDialog(eligible)"
                  [attr.aria-label]="'View universities offering ' + eligible.career.name">
                  <span aria-hidden="true">üèõÔ∏è</span> View Universities
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Close to Qualifying - Grouped by Curriculum -->
    <div *ngIf="closeCareers.length > 0" class="careers-section close-section" aria-labelledby="close-heading">
      <h3 id="close-heading" class="section-title">
        <span class="icon" aria-hidden="true">üéØ</span>
        <span class="sr-only">Close to qualifying section: </span>
        Close to Qualifying ({{ closeCareers.length }})
      </h3>
      <p class="section-description">You're almost there! These careers are within reach with a little improvement, organized by university curriculum.</p>
      
      <!-- Grouped by Category -->
      <div *ngFor="let category of getCategoryKeys()" class="category-group">
        <h4 class="category-title">
          <span class="category-icon">{{ getCategoryIcon(category) }}</span>
          {{ category }} ({{ closeCareersByCategory[category].length }})
        </h4>
        
        <div class="careers-grid">
          <div *ngFor="let eligible of closeCareersByCategory[category]" class="career-card close">
            <div class="career-header">
              <h4>{{ eligible.career.name }}</h4>
              <span class="status-badge close-badge">{{ getStatusLabel(eligible.status) }}</span>
            </div>
            <div class="career-info">
              <div class="match-score">
                <span class="score-label">Match Score:</span>
                <span class="score-value">{{ eligible.matchScore }}%</span>
              </div>
              
              <div *ngIf="getEnteredSubjects(eligible.closeSubjects, eligible.career.name, 'close').length > 0" class="close-subjects">
                <p class="info-label">Almost there in:</p>
                <ul class="subject-list">
                  <li *ngFor="let subject of getEnteredSubjects(eligible.closeSubjects, eligible.career.name, 'close')">
                    <ng-container *ngIf="getImprovementDetails(eligible, subject) as details; else noDetails">
                      <ng-container *ngIf="details.current !== undefined && details.current !== null">
                        <div class="subject-improvement">
                          <span class="subject-name">{{ subject }}</span>
                          <span class="improvement-details">
                            <span class="current-grade">Current: {{ details.current }}%</span>
                            <span class="required-grade">Required: {{ details.required }}%</span>
                            <span class="improvement-needed">Need: +{{ details.improvement }}%</span>
                          </span>
                        </div>
                      </ng-container>
                    </ng-container>
                    <ng-template #noDetails></ng-template>
                  </li>
                </ul>
              </div>
              
              <div *ngIf="getEnteredSubjects(eligible.missingSubjects, eligible.career.name, 'missing').length > 0" class="missing-subjects">
                <p class="info-label">Need improvement in:</p>
                <ul class="subject-list">
                  <li *ngFor="let subject of getEnteredSubjects(eligible.missingSubjects, eligible.career.name, 'missing')">
                    <ng-container *ngIf="getImprovementDetails(eligible, subject) as details; else noDetails">
                      <ng-container *ngIf="details.current !== undefined && details.current !== null">
                        <div class="subject-improvement">
                          <span class="subject-name">{{ subject }}</span>
                          <span class="improvement-details">
                            <span class="current-grade">Current: {{ details.current }}%</span>
                            <span class="required-grade">Required: {{ details.required }}%</span>
                            <span class="improvement-needed">Need: +{{ details.improvement }}%</span>
                          </span>
                        </div>
                      </ng-container>
                    </ng-container>
                    <ng-template #noDetails></ng-template>
                  </li>
                </ul>
              </div>
              
              <!-- Market Data Section -->
              <div class="market-data-section">
                <div *ngIf="isMarketDataLoading(eligible.career.name)" class="market-loading">
                  <span>Loading market data...</span>
                </div>
                
                <div *ngIf="!isMarketDataLoading(eligible.career.name) && getMarketData(eligible.career.name)" class="market-info">
                  <!-- Total Job Count (Last 12 Months) -->
                  <div *ngIf="getMarketData(eligible.career.name)?.totalJobCount" class="job-count">
                    <span class="market-label">
                    <span aria-hidden="true">üìä</span>
                    <span class="sr-only">Market data: </span>
                    Total Jobs (Last 12 Months):
                  </span>
                    <span class="count-value">{{ formatNumber(getMarketData(eligible.career.name)!.totalJobCount!) }}</span>
                    <div *ngIf="getMarketData(eligible.career.name)?.jobCountsBySite && getMarketData(eligible.career.name)!.jobCountsBySite!.length > 0" class="job-counts-by-site">
                      <span class="sites-label">From:</span>
                      <span *ngFor="let siteCount of getMarketData(eligible.career.name)!.jobCountsBySite!" class="site-count">
                        {{ siteCount.site }} ({{ formatNumber(siteCount.count) }})
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- University Button -->
              <div class="university-button-section" *ngIf="hasUniversitySources(eligible.career)">
                <button 
                  class="view-universities-btn"
                  (click)="openUniversityDialog(eligible)"
                  [attr.aria-label]="'View universities offering ' + eligible.career.name">
                  <span aria-hidden="true">üèõÔ∏è</span> View Universities
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- No Qualifications -->
    <div *ngIf="qualifiedCareers.length === 0 && closeCareers.length === 0" class="no-qualifications" role="status" aria-live="polite">
      <div class="empty-state">
        <span class="icon" aria-hidden="true">üìö</span>
        <h3>Keep Working!</h3>
        <p>Based on your current grades, you haven't qualified for any careers yet. But don't worry!</p>
        <p class="encouragement">Select a desired career above to see exactly what you need to improve.</p>
      </div>
    </div>
  </div>
</section>

<div *ngIf="!grades || Object.keys(grades).length === 0" class="no-grades" role="status" aria-live="polite">
  <div class="empty-state">
    <h3>Enter Your Grades</h3>
    <p>Enter your grades above to see which courses and careers you qualify for!</p>
  </div>
</div>

<!-- University Dialog -->
<app-university-dialog
  *ngIf="selectedCareerForDialog && selectedQualificationLevel"
  [career]="selectedCareerForDialog"
  [qualificationLevel]="selectedQualificationLevel"
  [grades]="grades"
  [countryCode]="selectedCountry?.code || 'ZA'"
  [isOpen]="showUniversityDialog"
  (closeDialog)="closeUniversityDialog()">
</app-university-dialog>

